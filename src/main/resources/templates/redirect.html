<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
   <title>인증 토큰 내장 저장소 저장</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
   	<h1>축하축하 인증 토큰 내장 저장소 저장</h1>
   
    <button onclick="request()">내 페이지</button><br/>
    <button onclick="logout()">로그아웃</button><br/>
   	<button onclick="valid()">토큰유효성체크</button><br/>
   	<button onclick="refresh()">새토큰발급</button>

	<div id="result"></div>

<script>
	window.onload=function() {
		
 	    function getUrlParameter(name) {
	        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
	        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
	        var results = regex.exec(this.location.search);
	        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
	    };
		
	    const accessToken = getUrlParameter('accessToken');
	    
	    if(accessToken) {
	    	localStorage.setItem('accessToken', accessToken);
	    }
	    
		const result = document.getElementById('result');
	}

	function valid(){
		var now = new Date().getTime();
		var exp = parseJwt(localStorage.getItem('accessToken')).exp;
		var check =  exp > now;
		result.innerHTML = "now: "+now+", exp: "+exp+", result: "+ check;
	}
	
	function parseJwt (token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
	    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
	        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	    }).join(''));

	    return JSON.parse(jsonPayload);
	};

	function request(){
		fetch("/user/me", {
			method: "GET",
			headers: {
				'Content-Type': 'application/json',
				'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
	        }
		})
		.then(response => {
			if (response.ok) {
				response = response.json()
				result.innerHTML = response.toString();
			} else {
			      return Promise.reject(response);
			}
		})
		.catch(err => console.log(err));
	} 
	
	function logout(){
		var data = {'accessToken' : localStorage.getItem('accessToken')};
		fetch("/auth/logout", {
			method: "POST",
			headers: {
				'Content-Type': 'application/json' 
			},
			body: JSON.stringify(data)
		})
		.then(response => {
			result.innerHTML = 'logout';
			localStorage.clear();
		})
	}
	
	function refresh(){
		
		var data = {'accessToken' : localStorage.getItem('accessToken')};
		
		fetch("/auth/refresh", {
			method: "POST",
			headers: {
				'Content-Type': 'application/json' 
			},
			body: JSON.stringify(data)
		})
		.then(response => response.json())
		.then(data => console.log(data));
	}
</script>
</body>
</html>